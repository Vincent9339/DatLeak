name: Build and Push to GHCR

env:
  GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}

on:
  push:
    branches: ["main"]
  release:
    types: [created]

jobs:
  deploy:
    runs-on: ubuntu-latest

    container:
      image: quay.io/apptainer/apptainer:v1.3.0  

    permissions:
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Build Apptainer Image (.sif)
        run: |
          apptainer build dataleak.sif apptainer/dataleak.def

      - name: Login to GHCR
        run: |
          echo "${{ secrets.GHCR_TOKEN }}" | apptainer remote login \
            --username "${{ github.repository_owner }}" \
            --password-stdin ghcr.io

      - name: Push to GHCR
        run: |
          apptainer push dataleak.sif oras://ghcr.io/${{ github.repository_owner }}/dataleak:latest
